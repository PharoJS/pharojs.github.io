<!DOCTYPE html>
<html>
<head>
  <title>FAQ | PharoJS</title>
<meta name="description" content="PharoJS Frequently Asked Questions">
<meta name="twitter:description" content="PharoJS Frequently Asked Questions">
<style>
div.answer{display:none}
li.show>div.answer{display:block}
.openClose>.show{list-style-image: url('img/open.png')}
.openClose>:not(.show){list-style-image: url('img/closed.png')}
.openClose>li>a{font-size:150%;cursor:pointer;}
ul.openClose ul{list-style-image: initial;}
</style>
</head>

<body>
    <script type="text/javascript" src="https://pharojs.atlassian.net/s/d41d8cd98f00b204e9800998ecf8427e-T/-3szkjr/b/c/ced29afba244973b16a7e99d069f29b8/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-US&collectorId=59e53daf"></script>
	<link rel="stylesheet" type="text/css" href="css/pharoJS.css"/>
	<div class="pjHeader">
		<a href="http://pharojs.org"><img alt="PharoJS Logo" src="img/pharoJsBicolorLogo2016-08-12.png"></a>
		<h1>Frequently Asked Questions</h1>
    </div>
<h2>General Questions</h2>
<ul class="openClose">
  <li><a>Where can I get help with PharoJS?</a>
  <div class="answer">
    The best place is with the <a href="https://pharojs.slack.com">PharoJS Slack workspace</a>.
    To get an account there, either send a twitter direct-message to <a href="https://twitter.com/pharojs">@pharojs</a> or an email to <a href="email:pharojs@scs.ryerson.ca">pharojs@scs.ryerson.ca</a>.
  </div>
  </li>

  <li><a>Where can I find the PharoJS documentation?</a>
  <div class="answer">
    The PharoJS documentation is <a href="doc.html">available at this linked page</a>.
    It includes (but not restricted to) conference papers and slides of talks presenting different facets of PharoJS.
  </div>
  </li>

  <li><a>How do I install PharoJS?</a>
  <div class="answer">
    <p>Install can be done inside a <a title="Download Pharo" href="http://pharo.org/download" target="_blank">Pharo 5 image</a> by evaluating the following in a playground:
    <pre>
    Gofer it
    smalltalkhubUser: 'noury' project: 'PharoJS';
    configurationOf: #PharoJS ;
    loadBleedingEdge.
    </pre>

    This will install the most recent public version.
    To install the latest stable version, please use <code>loadStable</code> instead of <code>loadBleedingEdge</code>.
    </p>
    <p>
    Upon install, Pharo will download HTML code for examples.
    The are located in the <code>PharoJS-master</code> foloder along with the image and the change file. It contains subfolders for each example and test.
    </p>
    <p>
    After installation you should run all of the PharoJS test to verify that your setup is working correctly.
    </p>
  </div>
  </li>

  <li><a>Does PharoJS work with Pharo6?</a>
  <div class="answer">
    Pharo6 had some stability issues, so we elected to skip Pharo 6.
    PharoJS will be available on Pharo 7 shortly after it is available.
  </div>
  </li>

  <!-- <li><a>Is there a PharoJS pre-builtImage?</a>
  <div class="answer">
  </div>
  </li> -->

  <li><a>Where can I find the HTML code for App tests (e.g. PjCounterApp and PjMinimalApp)?</a>
  <div class="answer">
    Some tests require a folder with HTML + CSS + ... files. They can be found in the PharoJS Git repository: <a href="https://github.com/bouraqadi/PharoJS">https://github.com/bouraqadi/PharoJS</a>.
  </div>
  </li>

  <li><a>Where can I download the ESUG 2016 Demo (Pharo 4 image + Web App + PhoneGap App)?</a>
  <div class="answer">
    A ready to use Pharo 4 image with the demo from <a href="doc.html#esug2016Talk">the ESUG 2016 talk</a>. The zip file  includes the files (e.g. HTML) for the web app and for the PhoneGap mobile application [<a href="https://docs.google.com/uc?id=0B7fN7OYplsLmcG9Cb3pDcWVYS00&export=download" target="_blank">ZIP approx. 85 MB</a>]
  </div>
  </li>

  <li><a>Where can I find a video explanation of PharoJS with examples?</a>
  <div class="answer">
    <iframe width="560" height="315" src="https://www.youtube.com/embed/XWd2mCQPZUU?rel=0&amp;showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
  <div class="answer">
  </li>

  <li><a>Are there any PharoJS goodies (Shirts, Mugs...)?</a>
  <div class="answer">
    Different PharoJS goodies are available. Please click on the picture below.
    <center><a onclick="" href="http://www.zazzle.com/collections/pharojs-119096008034094659" target="_blank"><img src="img/swag.jpg"></a></center>
  </div>
  </li>

</ul>

<h2>PharoJS code questions</h2>
<ul class="openClose">
  <li><a>How can I create a <code>KeyboardEvent</code> or <code>MouseEvent</code>?</a>
  <div class="answer">
    <pre>
    window KeyboardEvent new: #keypress with: { #key -> #Enter. #keyCode -> 13. #which -> 13 } asDictionary
    window MouseEvent new: #click
    </pre>
  </div>
  </li>

  <li><a>How can I create a DOM object?</a>
  <div class="answer">
    <pre>
	rectangle := document createElement: 'div'.
	rectangle id: 'grn'.
	document body appendChild: rectangle.
    </pre>
  </div>
  </li>

  <li><a>How do I reference a field in a native Javascript object? Call a method?</a>
  <div class="answer">
    <p>
    In most cases, simply treating it as a message send works:
    <pre>
	jsobj fieldName.             " equivalent to jsobj.fieldName "
	jsobj fieldName: 0.          " equivalent to jsobj.fieldName=0 "
    </pre>
    You do exactly the same to call a method:
    <pre>
	jsobj methodName.            " equivalent to jsobj.methodName() "
	jsobj methodName: 0.         " equivalent to jsobj.methodName(0) "
	jsobj methodName: 0 foo: 42. " equivalent to jsobj.methodName(0,42) "
	jsobj methodName: 0 bar: 42. " equivalent to jsobj.methodName(0,42) "
    </pre>
    Notice that the message name for multiple parameters is only matched to the first parameter, so the last 2 examples are functionally identical.
    </p>
    <p>
    If the field is a method (function) then simply referencing it will call it, so to get or change the value you must use:
    <pre>
	jsobj instVarNamed:#count.
	jsobj instVarNamed:#count put: 0.
    </pre>
    You can also use this to force creation of a slot.
    </p>
    <p>
      There is a minor detail about Javascript "classes" such as <code>MouseEvent</code> because they are implemented as special Javascript functions, but usually you don't want to call them, you want to send them a <code>new</code> message.
      So if the message name starts with an uppercase letter, it is treated as a value reference, rather than as a function.
      This allows the following to work:
      <pre>
    window MouseEvent new: #click
      </pre>
      </p>
  </div>
  </li>
  
  <li><a>Why can't PharoJS do ...?</a>
  <div class="answer">
    <p>
    The premise of PharoJS is that you can develop code in the Pharo IDE with the GUI in the browser, including running tests.
    Then when you're finished, you can export the whole thing to Javascript and have it execute the same way (or similar, see the <a href="#differences">question about differences</a>).
    </p>
    <p>
    To achieve this, we communicate across a bridge between the running Pharo image and the running browser (see the <a href="#bridge">question about the bridge</a>).
    This means that there are limitations in how processing on the browser side can proceed.
    Most paticularly, you can't call-back a block (and wait for the return value) from within code running on the browser.
    The closest you can do is call a block, and pass it a continuation block as a parameter.
    It could then run on the Pharo side, and call the browser block passing the result.
    </p>
    <p>
    We control the transpilation to Javascript, but we have no control over the Pharo Smalltalk compilation, so we can't add any fundamentally new concept.
    </p>
  </div>
  </li>

  <li><a name="bridge">How does the bridge work? What are proxies?</a>
  <div class="answer">
    <p>
    The bridge is used during development to connect the running Pharo image and the running PharoJS code in the browser - but does not exist in production code.
    The bridge is implemented over a WebSocket which allows bi-directional asynchronous communication.
    </p>
    <p>
    There are proxy objects on the Pharo side that represent objects on the browser.
    Some of there are global proxies, such as <code>document</code>, <code>window</code>, etc. which are implemented as Javascript globals (see the <a href="#globals">question on globals</a>).
    When you send a message to a proxy, a DNU intervenes and sends the parameters across the bridge to the browser, which calls the method on the object referred to by the proxy, and returns the result.
    <ul>
      <li>
      If that result is a simple value (number, boolean, string, nil) it is returned across the bridge to the Pharo side which has suspended your code, awaiting the response.
      The response is converted to a Smalltalk value, and returned to your code.
      </li>
      <li>
      If that result is not a simple value, a reference to that value is created (so it doesn't get garbage collected by the browser), and a reference is passed back across the bridge.
      That reference is converted to a proxy, and that proxy is returned to your code.
      </li>
      <li>
      When all references to that proxy have disappeared on the Pharo side, the browser side is told to remove the holding reference.
      </li>
    </ul>
    </p>
    <p>
    The other main thing that comes across the bridge are callbacks.
    A callback is a reflection of an event occuring on the broswer.
    The structure for callbacks is created by sending an <code>addEventListener:block:</code> message to a proxy (see the <a href="#addEventListener">question on this</a>).
    In order to faithfully emulate the Javascript execution model, no callback can happen while an existing callback is executing, or while any initial interaction with the browser is taking place.
    </p>
  </div>
  </li>

  <li><a name="addEventListener">Why do I need to use <code>addEventListener:block:</code> to set event handlers?</a>
  <div class="answer">
    The structure for callbacks is created by sending an <code>addEventListener:block:</code> message to a proxy (typically of a DOM object).
    The referenced Smalltalk block must be held as long as there are references to it on the browser.
    Unfortunately, there isn't currently a weak data-structure available in browsers that would allow us reliably to clean these up.
    So we resort to using reference counting, so you also need to use <code>addEventListener:block:</code> with a <code>nil</code> block to remove the callback.
    Not explicitly removing a callback can lead to memory being tied up on the Pharo side until the bridge is closed, but seems like a reasonable trade-off as it only applies during development.
  </div>
  </li>

  <li><a name="differences">What are the differences between normal Smalltalk and PharoJS Smalltalk?</a>
  <div class="answer">
    We try very hard to make the translation from Smalltalk to Javascript seamless, but there are some differences that are either impossible to handle, or would be hugely inefficient:
    <ul>
      <li>The numeric stack: in Javascript all numbers are IEEE <code>double</code>s, so there are no big-ints, or fractions.</li>
      <li><code>thisContext</code> does not exist, so any method that references it will be uncompilable.</li>
      <li><code>become:</code> is unsupported.</li>
      <li>Primitives are not supported.</li>
      <li>There are no processes.</li>
    </ul>
  </div>
  </li>

  <li><a name="importMethods">How do I reference methods from Pharo classes (like <code>Number class&gt;&gt;#primesUpTo:</code>?</a>
  <div class="answer">
    Unfortunately, “<em>automatically importing methods from Pharo classes for classes we have duplicated (like <code>Number</code>) or other classes without importing the whole class</em>” is on our todo list.
    In the meantime, add the following to <code>PjNumber</code> class-side:
    <pre>jsTranspilationImportMethodsNonstandard
	&lt;pharoJsSkip&gt;
	^ {
		Number class -> #(primesUpTo: primesUpTo:do:).
           }</pre>
    This says to import those 2 methods from the <code>Number</code> class.
    This is the user definable version of <code>jsTranspilationImportMethods</code> (for which <code>PjNumber</code> has quite a large implementation) which allows you to augment the list of methods that it imports.
    <p>
      We can't import all of e.g. <code>Number</code> or <code>Object</code>, because it would cause considerable code bloat in your application, and because there are methods in some of those classes that cannot be compiled (see the <a href="#differences">differences question</a>).
    </p>
  </div>
  </li>

  <li><a>Can I generate code for NodeJS? Can I use Node modules?</a>
  <div class="answer">
    <p>
    Yes, you certainly can use Node.
    Many people would question the decision as they would prefer to provide the application in Pharo directly, with all the advantages that entails.
    However, there are situations where deploying as Node is preferred (such as creating an Electron application - before you ask: we don't have that quite figured out yet, but we'd help someone who wants to).
    </p>
    <p>
    Subclass <code>PjNodeApplication</code>.
    </p>
    <p>
    To access modules, define a polyfill similar to <code>PjWebSocketPolyfill</code> (see the <a href="#polyfill">question on polyfills</a>).
    </p>
  </div>
  </li>

  <li><a name="polyfill">What are polyfills?</a>
  <div class="answer">
    <p>
    <a href="https://en.wikipedia.org/wiki/Polyfill_(programming)">A polyfill</a> is <a href="https://en.wikipedia.org/wiki/Shim_(computing)"> a code shim</a> that implements a feature on Javascript engines that do not otherwise support the feature.
    In PharoJS, polyfills add code at the beginning of the generated Javascript that does whatever is necessary to make a global value/class available in the Javascript engine.
    As such, a polyfill is a Javascript global (see the <a href="#globals">question on globals</a>).
    </p>
    <p>
    To define a polyfill, a subclass of <code>PjJavascriptGlobals</code> must define one or more of <code>browserPolyfill:</code>, <code>domPolyfill:</code>, or <code>nodePolyfill:</code> to output the necessary Javascript to set up the polyfill.
    </p>
  </div>
  </li>

  <li><a name="globals">How do I access Javascript global values?</a>
  <div class="answer">
    <p>
    PharoJS uses the Pharo Smalltalk pool dictionary facility to make Javascript globals available to code running in the Pharo image.
    In particular groups of such symbols are defined in subclasses of <code>PjJavascriptGlobals</code> and initialized with proxy values (see the <a href="#bridge">question on the bridge</a>) so they can be accessed.
    The appropriate globals are automatically available to subclasses of <code>PjApplication</code>.
    If you need them in a class that doesn't subclass that, add a <code>poolDictionaries:</code> parameter to your <code>subclass:instanceVariableNames:classVariableNames:package:</code> (see <code>PjBrowserApplication</code> for an example).
    </p>
    <p>
    It you create your own globals, you should use the trait <code>PjTJavascriptGlobalsInitializer</code> which defines a class <code>initialize</code> method so that a proxy is available.
    </p>
  </div>
  </li>

</ul>

<h2>Dealing with errors</h2>
<ul class="openClose">
  <li><a>PharoJS tests and playground raise on Safari error: <code>SecurityError (DOM Exception 18): The operation is insecure</code></a>
  <div class="answer">
    <p>This error prevents running PharoJS tests with Safari as a default browser. This problem also arises when opening a PharoJS playground on a app (e.g. `PjCounterBrowserApp`).</p>
    
    <p>The cause of the bug is that currently, we open HTML files from the disk. This works fine with Firefox and Chrome. But, <a href="https://stackoverflow.com/questions/24997292/localstorage-access-from-local-file">Safari's new security system forbids accessing JS global `localStorage` when the HTML or the JS code is loaded from <code>file://</code></a></p>
    
    <p>Luckily, there is a workaround. First, ensure you have the <a href="https://developer.apple.com/safari/tools/">Safari developer tools installed</a>. Then, in the `Develop` menu check the "Disable local file restrictions"  item.</p>
    
    <p>This is needed only during development. Once your app is ready for production, you export the code and make it available on a server. You should not experience the issue.</p>
    
    <p>Don't forget that PharoJS allows building HTML apps. Thus, if you require accessing sensitive resources, you are likely to have to define a <a href="https://content-security-policy.com/">content security policy</a> in your HTML file using the <code>meta</code> tag. You can find some examples in <a href="https://stackoverflow.com/questions/30280370/how-does-content-security-policy-work">the Stack overflow response addressing this question</a></p>
  </div>
  </li>


</ul>

<script>
(function(){
function showIt(href) {console.log(href);
Array.prototype.slice.call(document.getElementsByClassName("answer")).forEach(function(div) {
var node=div.parentNode;
if (node.children[0].name==href) node.classList.add("show");
});}
var href=document.location.href,hash=href.indexOf('#')+1;
if (hash>0) {
showIt(href.substring(hash));
href=href.substring(0,hash);
} else {href=href+"#";hash=href.length}
Array.prototype.slice.call(document.getElementsByClassName("answer")).forEach(function(div) {
var node=div.parentNode;
node.children[0].addEventListener("click",function(e){e.stopPropagation();e.preventDefault();node.classList.toggle("show");});
});
Array.prototype.slice.call(document.getElementsByTagName("a")).forEach(function(a) {
if (a.href.substring(0,hash)==href) {
console.log(a.href);
a.addEventListener("click",function(e){showIt(a.href.substring(hash));});
}});
Array.prototype.slice.call(document.getElementsByClassName("openClose")).forEach(function(ul) {console.log(ul)});
})();
</script>
</body>
</html>
<!--
-*- Local Variables: 
-*- coding: utf-8
-*- mode: HTML
-*- fill-column: 1000
-*- End:
-->
